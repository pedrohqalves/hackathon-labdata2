{"paragraphs":[{"title":"Exibir databases","text":"%pyspark\nspark.sql(\"show databases\").show()\n","user":"anonymous","dateUpdated":"2020-03-07T17:15:50+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-------------------+\n|       databaseName|\n+-------------------+\n|            default|\n|           sampledb|\n|sessions_ecommerce2|\n+-------------------+\n\n"}]},"apps":[],"jobName":"paragraph_1583601159498_1406130263","id":"20181208-134230_1861185261","dateCreated":"2020-03-07T17:12:39+0000","dateStarted":"2020-03-07T17:15:50+0000","dateFinished":"2020-03-07T17:16:17+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2627"},{"title":"Acessar database e exibir tabelas","text":"%pyspark\nspark.sql(\"use sessions_ecommerce2\")\nspark.sql(\"show tables\").show()","user":"anonymous","dateUpdated":"2020-03-07T17:16:39+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-------------------+----------+-----------+\n|           database| tableName|isTemporary|\n+-------------------+----------+-----------+\n|sessions_ecommerce2|aggregated|      false|\n|sessions_ecommerce2|   rawdata|      false|\n+-------------------+----------+-----------+\n\n"}]},"apps":[],"jobName":"paragraph_1583601159501_-677165107","id":"20181208-134259_1561086742","dateCreated":"2020-03-07T17:12:39+0000","dateStarted":"2020-03-07T17:16:39+0000","dateFinished":"2020-03-07T17:16:39+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:2628"},{"title":"selecionar tabela rawdata","text":"%pyspark\ndf = spark.sql(\"select * from sessions_ecommerce2.rawdata\")\ndf.show()","user":"anonymous","dateUpdated":"2020-03-07T17:17:16+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------+------------------+-------------------+----------+------------+--------------------+-----------+-----------+-----------+-----------+\n|custid|       trafficfrom|                url|    device|touchproduct|     trans_timestamp|partition_0|partition_1|partition_2|partition_3|\n+------+------------------+-------------------+----------+------------+--------------------+-----------+-----------+-----------+-----------+\n|   209| email_MyFirstBeer|   beer_vitrine_nav|   browser|           0|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   250|             Alexa|      beer_checkout|app_tablet|          52|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   128|             Alexa|          beer_cart|app_tablet|         124|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   502| email_MyFirstBeer|   beer_vitrine_nav|app_tablet|           0|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   542|       twitter.com|beer_product_detail|   browser|         190|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   535|            google|beer_product_detail|app_mobile|         108|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   148|    Jao_Cervejeiro|   beer_vitrine_nav|   browser|           0|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   209|             Alexa|   beer_vitrine_nav|app_mobile|           0|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   136|             Alexa|beer_product_detail|app_mobile|          85|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   332|        amazon.com|   beer_vitrine_nav|app_tablet|           0|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   339|email_CampanhaBeer|   beer_vitrine_nav|app_mobile|           0|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   337|    Jao_Cervejeiro|      beer_checkout|app_tablet|          79|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   224|             Alexa|          beer_cart|app_mobile|         206|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   527|             Alexa|beer_product_detail|   browser|         110|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   338| email_MyFirstBeer|   beer_vitrine_nav|app_tablet|           0|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   306|        amazon.com|   beer_vitrine_nav|app_mobile|           0|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   449|email_CampanhaBeer|   beer_vitrine_nav|app_mobile|           0|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   208|      facebook.com|beer_product_detail|   browser|         242|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   101|            google|beer_product_detail|   browser|         230|2020-03-07T16:00:...|       2020|         03|         07|         16|\n|   201|        BeerHug_TV|      beer_checkout|app_mobile|          31|2020-03-07T16:00:...|       2020|         03|         07|         16|\n+------+------------------+-------------------+----------+------------+--------------------+-----------+-----------+-----------+-----------+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1583601159502_1458964576","id":"20181208-134500_546755517","dateCreated":"2020-03-07T17:12:39+0000","dateStarted":"2020-03-07T17:17:16+0000","dateFinished":"2020-03-07T17:17:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:2629"},{"title":"Também é possível acessar diretamente o S3 em vez de ler tabelas","text":"%pyspark\n# substitua o <bucket-name> pelo nome do seu bucket. Coloque ano, mes, dia e hora que exista no seu bucket s3. \n# df = spark.read.json(\"s3://<bucket-name>/rawdata/ano/mes/dia/hora/\")\ndf = spark.read.json(\"s3://time-conta6-demo-ecomm-bucket-stream/rawdata/2020/03/07/13/\")\ndf.show()","user":"anonymous","dateUpdated":"2020-03-07T17:20:57+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+------+----------+------------+------------------+--------------------+-------------------+\n|custid|    device|touchproduct|       trafficfrom|     trans_timestamp|                url|\n+------+----------+------------+------------------+--------------------+-------------------+\n|   321|app_mobile|           0|             Alexa|2020-03-07T13:33:...|   beer_vitrine_nav|\n|   412|app_mobile|         232|             Alexa|2020-03-07T13:33:...|beer_product_detail|\n|   347|app_tablet|         234|       twitter.com|2020-03-07T13:33:...|          beer_cart|\n|   216|app_mobile|           0|    Jao_Cervejeiro|2020-03-07T13:33:...|   beer_vitrine_nav|\n|   118|   browser|         160|             Alexa|2020-03-07T13:33:...|beer_product_detail|\n|   221|app_tablet|         229|        BeerHug_TV|2020-03-07T13:33:...|beer_product_detail|\n|   121|app_mobile|         199| email_MyFirstBeer|2020-03-07T13:33:...|      beer_checkout|\n|   236|app_tablet|          20|        amazon.com|2020-03-07T13:33:...|beer_product_detail|\n|   309|   browser|          60|    Jao_Cervejeiro|2020-03-07T13:33:...|      beer_checkout|\n|   213|   browser|         210|email_CampanhaBeer|2020-03-07T13:33:...|      beer_checkout|\n|   222|app_mobile|           0| email_MyFirstBeer|2020-03-07T13:33:...|   beer_vitrine_nav|\n|   211|   browser|         115|email_CampanhaBeer|2020-03-07T13:33:...|beer_product_detail|\n|   225|   browser|         165|        amazon.com|2020-03-07T13:33:...|      beer_checkout|\n|   131|app_tablet|          21|        BeerHug_TV|2020-03-07T13:33:...|          beer_cart|\n|   530|app_mobile|         189|    Jao_Cervejeiro|2020-03-07T13:33:...|beer_product_detail|\n|   328|app_mobile|           0|             Alexa|2020-03-07T13:33:...|   beer_vitrine_nav|\n|   337|app_mobile|         186|      facebook.com|2020-03-07T13:33:...|          beer_cart|\n|   421|   browser|         159|        BeerHug_TV|2020-03-07T13:33:...|      beer_checkout|\n|   203|app_tablet|         133|        BeerHug_TV|2020-03-07T13:33:...|beer_product_detail|\n|   538|app_tablet|          86|        BeerHug_TV|2020-03-07T13:33:...|      beer_checkout|\n+------+----------+------------+------------------+--------------------+-------------------+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1583601159502_-1884488238","id":"20181208-134540_1669931981","dateCreated":"2020-03-07T17:12:39+0000","dateStarted":"2020-03-07T17:20:57+0000","dateFinished":"2020-03-07T17:21:08+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:2630"},{"text":"%pyspark\n# substitua o <bucket-name> pelo nome do seu bucket. Coloque ano, mes, dia e hora que exista no seu bucket s3\n# df = spark.read.csv(\"s3://<bucket-name>/aggregated/ano/mes/dia/hora/\")\ndf2 = spark.read.csv(\"s3://time-conta6-demo-ecomm-bucket-stream/aggregated/2020/03/07/14/\")\ndf2.show()\n\n","user":"anonymous","dateUpdated":"2020-03-07T17:45:06+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-----------------+---+----------+--------------------+---+-------------------+-------------------+-----+-----+---+\n|              _c0|_c1|       _c2|                 _c3|_c4|                _c5|                _c6|  _c7|  _c8|_c9|\n+-----------------+---+----------+--------------------+---+-------------------+-------------------+-----+-----+---+\n|536_APP1583589780|536|app_tablet|2020-03-07 14:03:...|  1|          beer_cart|          beer_cart|03:54|03:54|  0|\n|111_APP1583589780|111|app_mobile|2020-03-07 14:03:...|  1|beer_product_detail|beer_product_detail|03:54|03:54|  0|\n|540_APP1583589780|540|app_mobile|2020-03-07 14:03:...|  1|          beer_cart|          beer_cart|03:54|03:54|  0|\n|520_BRO1583589780|520|   browser|2020-03-07 14:03:...|  1|beer_product_detail|beer_product_detail|03:54|03:54|  0|\n|114_BRO1583589780|114|   browser|2020-03-07 14:03:...|  1|      beer_checkout|      beer_checkout|03:54|03:54|  0|\n|448_APP1583589780|448|app_mobile|2020-03-07 14:03:...|  1|          beer_cart|          beer_cart|03:54|03:54|  0|\n|250_APP1583589780|250|app_mobile|2020-03-07 14:03:...|  1|beer_product_detail|beer_product_detail|03:54|03:54|  0|\n|317_APP1583589780|317|app_tablet|2020-03-07 14:03:...|  1|beer_product_detail|beer_product_detail|03:54|03:54|  0|\n|120_APP1583589780|120|app_mobile|2020-03-07 14:03:...|  1|   beer_vitrine_nav|   beer_vitrine_nav|03:54|03:54|  0|\n|345_BRO1583589780|345|   browser|2020-03-07 14:03:...|  2|          beer_cart|beer_product_detail|03:54|03:56|  2|\n|503_APP1583589780|503|app_mobile|2020-03-07 14:03:...|  1|beer_product_detail|beer_product_detail|03:54|03:54|  0|\n|113_APP1583589780|113|app_tablet|2020-03-07 14:03:...|  1|beer_product_detail|beer_product_detail|03:54|03:54|  0|\n|522_BRO1583589780|522|   browser|2020-03-07 14:03:...|  1|   beer_vitrine_nav|   beer_vitrine_nav|03:55|03:55|  0|\n|508_APP1583589780|508|app_mobile|2020-03-07 14:03:...|  1|beer_product_detail|beer_product_detail|03:55|03:55|  0|\n|230_APP1583589780|230|app_mobile|2020-03-07 14:03:...|  1|   beer_vitrine_nav|   beer_vitrine_nav|03:55|03:55|  0|\n|445_APP1583589780|445|app_mobile|2020-03-07 14:03:...|  1|   beer_vitrine_nav|   beer_vitrine_nav|03:55|03:55|  0|\n|310_BRO1583589780|310|   browser|2020-03-07 14:03:...|  1|   beer_vitrine_nav|   beer_vitrine_nav|03:55|03:55|  0|\n|350_APP1583589780|350|app_tablet|2020-03-07 14:03:...|  1|      beer_checkout|      beer_checkout|03:55|03:55|  0|\n|226_APP1583589780|226|app_mobile|2020-03-07 14:03:...|  1|   beer_vitrine_nav|   beer_vitrine_nav|03:55|03:55|  0|\n|437_BRO1583589780|437|   browser|2020-03-07 14:03:...|  1|beer_product_detail|beer_product_detail|03:55|03:55|  0|\n+-----------------+---+----------+--------------------+---+-------------------+-------------------+-----+-----+---+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1583601159502_-1041957904","id":"20181208-140532_192880319","dateCreated":"2020-03-07T17:12:39+0000","dateStarted":"2020-03-07T17:45:06+0000","dateFinished":"2020-03-07T17:45:14+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:2631"},{"text":"%pyspark\n\n# df2 = df2.withColumnRenamed(\"_c0\",\"sessionid\") \\\n# .withColumnRenamed(\"_c1\",\"userid\") \\\n# .withColumnRenamed(\"_c2\",\"userid\") \\\n# .withColumnRenamed(\"_c3\",\"aggreg_time\") \\\n# .withColumnRenamed(\"_c4\",\"events\") \\\n# .withColumnRenamed(\"_c5\",\"beginurl\") \\\n# .withColumnRenamed(\"_c6\",\"endurl\") \\\n# .withColumnRenamed(\"_c7\",\"begin_min_ss\") \\\n# .withColumnRenamed(\"_c8\",\"end_min_ss\") \\\n# .withColumnRenamed(\"_c9\",\"aggreg_time\")\n# .withColumnRenamed(\"partition_0\",\"year\") \\\n# .withColumnRenamed(\"partition_1\",\"month\") \\\n# .withColumnRenamed(\"partition_2\",\"day\") \\\n# .withColumnRenamed(\"partition_3\",\"hour\") \n\nnew_names = ['sessionid','userid','device','aggreg_time','events','beginurl',\n'endurl','begin_min_ss','end_min_ss','totaltime_sec']#,'year','month','day','hour']\ndf2 = df2.toDF(*new_names)\n\n\ndf2.show()","user":"anonymous","dateUpdated":"2020-03-07T18:43:06+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-----------------+------+----------+--------------------+------+-------------------+-------------------+------------+----------+-------------+\n|        sessionid|userid|    device|         aggreg_time|events|           beginurl|             endurl|begin_min_ss|end_min_ss|totaltime_sec|\n+-----------------+------+----------+--------------------+------+-------------------+-------------------+------------+----------+-------------+\n|536_APP1583589780|   536|app_tablet|2020-03-07 14:03:...|     1|          beer_cart|          beer_cart|       03:54|     03:54|            0|\n|111_APP1583589780|   111|app_mobile|2020-03-07 14:03:...|     1|beer_product_detail|beer_product_detail|       03:54|     03:54|            0|\n|540_APP1583589780|   540|app_mobile|2020-03-07 14:03:...|     1|          beer_cart|          beer_cart|       03:54|     03:54|            0|\n|520_BRO1583589780|   520|   browser|2020-03-07 14:03:...|     1|beer_product_detail|beer_product_detail|       03:54|     03:54|            0|\n|114_BRO1583589780|   114|   browser|2020-03-07 14:03:...|     1|      beer_checkout|      beer_checkout|       03:54|     03:54|            0|\n|448_APP1583589780|   448|app_mobile|2020-03-07 14:03:...|     1|          beer_cart|          beer_cart|       03:54|     03:54|            0|\n|250_APP1583589780|   250|app_mobile|2020-03-07 14:03:...|     1|beer_product_detail|beer_product_detail|       03:54|     03:54|            0|\n|317_APP1583589780|   317|app_tablet|2020-03-07 14:03:...|     1|beer_product_detail|beer_product_detail|       03:54|     03:54|            0|\n|120_APP1583589780|   120|app_mobile|2020-03-07 14:03:...|     1|   beer_vitrine_nav|   beer_vitrine_nav|       03:54|     03:54|            0|\n|345_BRO1583589780|   345|   browser|2020-03-07 14:03:...|     2|          beer_cart|beer_product_detail|       03:54|     03:56|            2|\n|503_APP1583589780|   503|app_mobile|2020-03-07 14:03:...|     1|beer_product_detail|beer_product_detail|       03:54|     03:54|            0|\n|113_APP1583589780|   113|app_tablet|2020-03-07 14:03:...|     1|beer_product_detail|beer_product_detail|       03:54|     03:54|            0|\n|522_BRO1583589780|   522|   browser|2020-03-07 14:03:...|     1|   beer_vitrine_nav|   beer_vitrine_nav|       03:55|     03:55|            0|\n|508_APP1583589780|   508|app_mobile|2020-03-07 14:03:...|     1|beer_product_detail|beer_product_detail|       03:55|     03:55|            0|\n|230_APP1583589780|   230|app_mobile|2020-03-07 14:03:...|     1|   beer_vitrine_nav|   beer_vitrine_nav|       03:55|     03:55|            0|\n|445_APP1583589780|   445|app_mobile|2020-03-07 14:03:...|     1|   beer_vitrine_nav|   beer_vitrine_nav|       03:55|     03:55|            0|\n|310_BRO1583589780|   310|   browser|2020-03-07 14:03:...|     1|   beer_vitrine_nav|   beer_vitrine_nav|       03:55|     03:55|            0|\n|350_APP1583589780|   350|app_tablet|2020-03-07 14:03:...|     1|      beer_checkout|      beer_checkout|       03:55|     03:55|            0|\n|226_APP1583589780|   226|app_mobile|2020-03-07 14:03:...|     1|   beer_vitrine_nav|   beer_vitrine_nav|       03:55|     03:55|            0|\n|437_BRO1583589780|   437|   browser|2020-03-07 14:03:...|     1|beer_product_detail|beer_product_detail|       03:55|     03:55|            0|\n+-----------------+------+----------+--------------------+------+-------------------+-------------------+------------+----------+-------------+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1583603110356_246034712","id":"20200307-174510_646481731","dateCreated":"2020-03-07T17:45:10+0000","dateStarted":"2020-03-07T18:22:41+0000","dateFinished":"2020-03-07T18:22:48+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:2632"},{"title":"Gravar o dataframe em formato parquet em um bucket de destino","text":"%pyspark\nDESTINO='s3://losbankeros-analytics/raw'\ndf.write \\\n    .format(\"parquet\") \\\n    .option(\"compression\", \"snappy\") \\\n    .mode(\"append\") \\\n    .save(path=DESTINO)\n    \nDESTINO2='s3://losbankeros-analytics/aggregated'    \ndf2.write \\\n    .format(\"parquet\") \\\n    .option(\"compression\", \"snappy\") \\\n    .mode(\"append\") \\\n    .save(path=DESTINO2)\n","user":"anonymous","dateUpdated":"2020-03-07T17:50:23+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1583601159502_1390000278","id":"20190412-232253_1471290996","dateCreated":"2020-03-07T17:12:39+0000","dateStarted":"2020-03-07T17:50:12+0000","dateFinished":"2020-03-07T17:50:14+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:2633"},{"text":"%pyspark\n\n\ndf.write.mode(\"overwrite\").saveAsTable('rawdata_new', format='parquet', mode='overwrite', path='s3a://losbankeros-analytics/raw')\ndf2.write.mode(\"overwrite\").saveAsTable('agreggated_new', format='parquet', mode='overwrite', path='s3a://losbankeros-analytics/aggregated')","user":"anonymous","dateUpdated":"2020-03-07T18:20:20+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1583601159503_2143469448","id":"20190412-232348_380602243","dateCreated":"2020-03-07T17:12:39+0000","dateStarted":"2020-03-07T18:20:20+0000","dateFinished":"2020-03-07T18:20:41+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:2634"},{"text":"%pyspark\n\n\n","user":"anonymous","dateUpdated":"2020-03-07T17:57:48+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1583603799904_1089195956","id":"20200307-175639_884289456","dateCreated":"2020-03-07T17:56:39+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:2635"}],"name":"Desafio Ecommerce - losbankeros","id":"2F5DV46Y8","noteParams":{},"noteForms":{},"angularObjects":{"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}